@model IEnumerable<Fedco.PHED.Agent.management.Models.UserTransaction>
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
@if ((int)Session["UserTypeId"] == 1)
{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
else
{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@Scripts.Render("~/bundles/dataTables", "~/bundles/tableTools")
<div class="btn-group btn-breadcrumb" style="margin-bottom:5px">
    @if ((int)Session["UserTypeId"] == 1)
    {
        <a href="@Url.Action("Index", "Admin")" class="btn btn-default"><i class="glyphicon glyphicon-home"></i></a>
    }
    else
    {
        <a href="@Url.Action("Home", "Account")" class="btn btn-default"><i class="glyphicon glyphicon-home"></i></a>
    }

    <a href="#" class="btn btn-default">Audit Log</a>

</div>
<div>
    <input type="hidden" id="hiddenLoginId" value="@Session["LoginUserId"]" />
    <input type="hidden" id="hiddenAgentId" value="@Session["AgentId"]" />
    <input type="hidden" id="hiddenSuperAgentId" value="@Session["SuperAgentId"]" />
    <input type="hidden" id="hiddenSubAgentId" value="@Session["SubAgentId"]" />
    <div id="tabs" style="width:99%">
        <ul>
            <li><a href="#tabs-1">User Master Audit</a></li>
            <li><a href="#tabs-2">Agents Audit</a></li>
            
        </ul>
        <div id="tabs-1">
            <div class='insideRow' style="width:95%;margin-top:10px">
                <table class="table table-striped table-bordered" id="userTable">
                    <thead>
                        <tr>
                            <th>
                                User ID
                            </th>
                            <th>
                                User Name
                            </th>
                            <th>
                                Activated
                            </th>
                            <th>
                                SuperAgent Name
                            </th>
                            <th>
                                Agent Name
                            </th>
                            <th>
                                SubAgent Name
                            </th>
                            <th>
                                Created By
                            </th>
                            <th>
                                Created Date
                            </th>
                            <th>
                                Modified Date
                            </th>
                            <th>
                                Modified By
                            </th>
                            <th>
                                IMEI NO
                            </th>
                            <th>
                                IMEI NO2
                            </th>
                            <th>
                                Action
                            </th>
                        </tr>
                    </thead>
                </table>
</div>
            </div>
            <div id="tabs-2">
                <div class='insideRow'>
                    <div class="transeditor-label" style="margin-top:7px">
                        <select id="drpReportType" class="drop-controlTrns">
                            <option selected="selected" value="1">Super Agent Master Audit</option>
                            <option value="2">Agent Master Audit</option>
                            <option value="3">Sub Agent Master Audit</option>
                        </select>

                        @if ((int)Session["UserTypeId"] == 1)
                        {
                        <span id="date-label-from" style="padding-left:10px" class="date-label">Super Agent: </span>
                        <select id="drpSuperAgents" name="drpSuperAgents" class="drop-controlTrns"></select>
                        <span id="date-label-from" style="padding-left:10px" class="date-label">Agent: </span>
                        <select id="drpAgents" name="drpAgents" class="drop-controlTrns"></select>
                        <span id="date-label-from" style="padding-left:10px" class="date-label">Sub Agent: </span>
                        <select id="drpSubAgents" name="drpSubAgents" class="drop-controlTrns"></select>
                        }
                        else if ((int)Session["UserTypeId"] == 2)
                        {
                        <span id="date-label-from" style="padding-left:10px" class="date-label">Agent: </span>
                        <select id="drpAgents" name="drpAgents"></select>
                        <span id="date-label-from" style="padding-left:10px" class="date-label">Sub Agent: </span>
                        <select id="drpSubAgents" name="drpSubAgents"></select>
                        }
                        else if ((int)Session["UserTypeId"] == 3)
                        {
                        <span id="date-label-from" style="padding-left:10px" class="date-label">Sub Agent: </span>
                        <select id="drpSubAgents" name="drpSubAgents"></select>
                        }


                        <input type="button" id="btnSearch" value="Search" class="btn btn-primary" />

                    </div>
                    <div class="transeditor-label">

                    </div>

                </div>
                <div class='insideRow' style="width:95%;margin-top:10px">
                    <table class="table table-striped table-bordered" id="agentTable">
                        <thead>
                            <tr>
                                <th>
                                    ID
                                </th>
                                <th>
                                    Agent Name
                                </th>
                                <th>
                                    Registartion Number
                                </th>
                                <th>
                                    Agent Code
                                </th>
                                <th>
                                    Created By
                                </th>
                                <th>
                                    Created Date
                                </th>
                                <th>
                                    Status
                                </th>
                                <th>
                                    Balance
                                </th>
                                <th>
                                    Modified By
                                </th>
                                <th>
                                    Modified Date
                                </th>
                                <th>
                                    Commission
                                </th>
                                <th>
                                    SecurityDeposit
                                </th>
                                <th>
                                    Approval Status
                                </th>
                                <th>
                                    Amount Approved Status
                                </th>
                                <th>
                                    Transfer Approved Status
                                </th>
                                <th>
                                    Reversal Approved Status
                                </th>
                                <th>
                                    Action
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

        </div>
   


</div>
    <script src="~/Scripts/jquery.dataTables.min.js"></script>
    <script src="~/Scripts/dataTables.bootstrap4.min.js"></script>
    <script src="~/Scripts/dataTables.buttons.min.js"></script>
    <script src="~/Scripts/buttons.bootstrap4.min.js"></script>
    <script src="~/Scripts/jszip.min.js"></script>
    <script src="~/Scripts/pdfmake.min.js"></script>
    <script src="~/Scripts/vfs_fonts.js"></script>
    <script src="~/Scripts/buttons.html5.min.js"></script>
    <script src="~/Scripts/buttons.print.min.js"></script>
    <script src="~/Scripts/moment.min.js"></script>
    <script src="~/Scripts/datetime-moment.js"></script>
    <link rel="stylesheet" href="~/Content/dataTables.bootstrap4.min.css" />
    <script type="text/javascript">
    $(function () {
        $.noConflict();
        $.fn.dataTable.moment('MM/DD/YYYY', 'en-US');
        $('#tabs').tabs();   
       
       
       // window.page.showProgress();
        var agenttable = $('#agentTable').DataTable({
            lengthChange: false,
            processing: true, // for show progress bar
            serverSide: false, // for process server side
            filter: true, // this is for disable filter (search box)
            orderMulti: false, // for disable multiple column at once
            buttons: ['excel', 'pdf', 'pageLength'],
            "scrollX": true,
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],

            "columns": [
                { "data": "AgentId", "width": "12%", "title": "ID ", "name": "ID", "autoWidth": true },
                { "data": "AgentName", "width": "12%", "name": "AgentName", "autoWidth": true },
                { "data": "RegistartionNumber", "width": "12%", "name": "RegistartionNumber", "autoWidth": true },
                { "data": "AgentCode", "width": "12%", "name": "AgentCode", "title": "Agent Code", "autoWidth": true },
                { "data": "CreatedBy", "width": "12%", "name": "CreatedBy", "title": "CreatedBy", "autoWidth": true },
                {
                    data: null, render: function (data) {
                        var date = new Date(data.CreatedDate);
                        var pattern = /Date\(([^)]+)\)/;
                        var results = pattern.exec(data.CreatedDate);
                        var dt = new Date(parseFloat(results[1]));

                        return window.moment(dt).format('MM/DD/YYYY');
                    }
                },
                { "data": "Status", "width": "12%", "name": "Status", "title": "Status", "autoWidth": true },
                { "data": "Balance", "width": "20%", "name": "Balance", "autoWidth": true },
                { "data": "ModifiedBy", "width": "20%", "name": "Modified By", "autoWidth": true },
                {
                    data: null, render: function (data) {
                        var date = new Date(data.ModifiedDate);
                        var pattern = /Date\(([^)]+)\)/;
                        var results = pattern.exec(data.ModifiedDate);
                        var dt = new Date(parseFloat(results[1]));

                        return window.moment(dt).format('MM/DD/YYYY');
                    }
                },
                { "data": "Commission", "width": "20%", "name": "Commission", "autoWidth": true },
                { "data": "SecurityDeposit", "width": "20%", "name": "SecurityDeposit", "autoWidth": true },
                { "data": "ApprovalStatus", "width": "20%", "name": "ApprovalStatus", "autoWidth": true },
                { "data": "isAmountApprovedStatus", "width": "20%", "name": "isAmountApprovedStatus", "autoWidth": true },
                { "data": "isTransferApprovedStatus", "width": "20%", "name": "isTransferApprovedStatus", "autoWidth": true },
                { "data": "isReversalApprovedStatus", "width": "20%", "name": "isReversalApprovedStatus", "autoWidth": true },
                { "data": "Action", "width": "20%", "name": "Action", "autoWidth": true },
            ],
            order: [[0, 'desc']]
        });

        agenttable.buttons().container()
            .appendTo('#agentTable_wrapper .col-md-6:eq(0)');
        var usertable = $('#userTable').DataTable({
            lengthChange: false,
            processing: true, // for show progress bar
            serverSide: false, // for process server side
            filter: true, // this is for disable filter (search box)
            orderMulti: false, // for disable multiple column at once
            buttons: ['excel', 'pdf', 'pageLength'],
            "scrollX": true,
            "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],

            "columns": [
                
                { "data": "UserId", "width": "12%", "title": "ID ", "name": "ID", "autoWidth": true },
                { "data": "Name", "width": "20%", "name": "Name", "autoWidth": true },
                { "data": "isActivated", "width": "12%", "name": "isActivated", "title": "Activated", "autoWidth": true },
                { "data": "superAgentName", "width": "12%", "name": "superAgentName", "autoWidth": true },
                { "data": "agentName", "width": "12%", "name": "agentName", "autoWidth": true },
                { "data": "subAgentName", "width": "12%", "name": "subAgentName", "autoWidth": true },
                { "data": "CreatedBy", "width": "12%", "name": "CreatedBy", "autoWidth": true },
                {
                    data: null, render: function (data) {
                        var date = new Date(data.CreatedTimestamp);
                        var pattern = /Date\(([^)]+)\)/;
                        var results = pattern.exec(data.CreatedTimestamp);
                        var dt = new Date(parseFloat(results[1]));

                        return window.moment(dt).format('MM/DD/YYYY');
                    }
                },
                {
                    data: null, render: function (data) {
                        var date = new Date(data.ModifiedTimestamp);
                        var pattern = /Date\(([^)]+)\)/;
                        var results = pattern.exec(data.ModifiedTimestamp);
                        var dt = new Date(parseFloat(results[1]));

                        return window.moment(dt).format('MM/DD/YYYY');
                    }
                },
                
                { "data": "ModifiedBy", "width": "12%", "name": "ModifiedBy", "title": "ModifiedBy", "autoWidth": true },
                { "data": "IMEI", "width": "12%", "name": "IMEI", "title": "IMEI", "autoWidth": true },
                { "data": "IMEI2", "width": "12%", "name": "IMEI2", "title": "IMEI2", "autoWidth": true },

                { "data": "Action", "width": "12%", "name": "Action", "title": "Action", "autoWidth": true },

               
            ],
            order: [[0, 'desc']]
        });

        usertable.buttons().container()
            .appendTo('#userTable_wrapper .col-md-6:eq(0)');

        function formatDate(date) {
            var d = new Date(date),
                month = '' + (d.getMonth() + 1),
                day = '' + d.getDate(),
                year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [month, day, year].join('/');
        }
        // Date range filter
        minDateFilter = "";
        maxDateFilter = "";
        var currentDate = new Date();


        minDateFilter = new Date().setDate(currentDate.getDate() - 90);
        maxDateFilter = new Date().setDate(currentDate.getDate());

         $.ajax({
                type: 'GET',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                url: '@Url.Action("GetUserAuditReport", "Audit")?startDate=' + formatDate(new Date(minDateFilter)) + '&EndDate=' + formatDate(new Date(maxDateFilter)),
                "dataSrc": '',
                success: function (response) {
                    usertable.rows().clear().draw();
                    usertable.rows.add(response); // Add new data
                    usertable.columns.adjust().draw();
                    window.page.hideProgress();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    window.page.hideProgress();
                },
            });





          $('#btnSearch').click(function () {
              var subagentId = $('#drpSubAgents :selected').val() == "" || $('#drpSubAgents :selected').val() == "-1" || $('#drpSubAgents :selected').val() == undefined ? 0 : $('#drpSubAgents :selected').val();
              var agentId = $('#drpAgents :selected').val() == "" || $('#drpAgents :selected').val() == "-1" || $('#drpAgents :selected').val() == undefined ? 0 : $('#drpAgents :selected').val();
              var spragentId = $('#drpSuperAgents :selected').val() == "" || $('#drpSuperAgents :selected').val() == "-1" || $('#drpSuperAgents :selected').val() == undefined ? 0 : $('#drpSuperAgents :selected').val();
              var reportType = $('#drpReportType :selected').val() == "" || $('#drpReportType :selected').val() == "-1" || $('#drpReportType :selected').val() == undefined ? 0 : $('#drpReportType :selected').val();
              window.page.showProgress();
              $.ajax({
                type: 'GET',
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                url: '@Url.Action("GetAuditReport", "Audit")?startDate=' + formatDate(new Date(minDateFilter)) + '&EndDate=' + formatDate(new Date(maxDateFilter)) + '&superAgentId=' + spragentId + '&agentId=' + agentId + '&subAgentId=' + subagentId + '&reportType=' + reportType,
                "dataSrc": '',
                success: function (response) {
                    agenttable.rows().clear().draw();
                    agenttable.rows.add(response); // Add new data
                    agenttable.columns.adjust().draw();
                    window.page.hideProgress();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    window.page.hideProgress();
                }
            });
          });

          $('#drpSuperAgents').empty();
          $('#drpAgents').empty();
          $('#drpSubAgents').empty();

          $('#drpSuperAgents').append('<option value = "-1">Select Super Agents</option>');
          $('#drpAgents').append('<option value = "-1">Select Agents</option>');
          $("#drpSubAgents").append('<option value = "">Select Sub Agents</option>');
          window.page.showProgress();
          $.ajax({
              type: 'GET',
              contentType: "application/json; charset=utf-8",
              url: '@Url.Action("GetSuperAgents", "Transaction")',
              data: null,
              success: function (data) {

                  $('#drpSuperAgents').empty();
                  $('#drpSuperAgents').append('<option value = "-1">Select Super Agents</option>');
                  $('#drpSuperAgents').val('');
                  if (data != null) {
                      $.each(data, function () {
                          $("#drpSuperAgents").append("<option value = " + this.AgentId + ">" + this.AgentName + "</option>");
                      });
                  }
                  window.page.hideProgress();
              },
              error: function (xhr, ajaxOptions, thrownError) {
                  window.page.hideProgress();
              },
              dataType: "json"
          });
         


         $("#drpAgents").change(function () {

             var agentId = $('#drpAgents :selected').val();
             if (agentId >= 0) {
                 window.page.showProgress();
                 $('#drpSubAgents').empty();
                 $('#drpSubAgents').append('<option value = "-1">Select Sub Agents</option>');
                 $('#drpSubAgents').val('');
                 $.ajax({
                     type: 'GET',
                     contentType: "application/json; charset=utf-8",
                     url: '@Url.Action("GetSubAgents", "Transaction")?agentID=' + agentId,
                     data: null,
                     success: function (data) {


                         if (data != null) {
                             $.each(data, function () {

                                 $("#drpSubAgents").append("<option value = " + this.AgentId + ">" + this.AgentName + "</option>");
                             });
                         }
                         window.page.hideProgress();
                     },
                     error: function (xhr, ajaxOptions, thrownError) {
                         window.page.hideProgress();
                     },
                     dataType: "json"
                 });


             }
         });

         $("#drpSuperAgents").change(function () {
                window.page.showProgress();
                var agentId = $('#drpSuperAgents :selected').val();
                if (agentId >= 0) {
                    $('#drpAgents').empty();
                    $('#drpAgents').append('<option value = "-1">Select Agents</option>');
                    $('#drpAgents').val('');
                 $.ajax({
                     type: 'GET',
                     contentType: "application/json; charset=utf-8",
                     url: '@Url.Action("GetAgents", "Transaction")?agentID=' + agentId,
                     data: null,
                     success: function (data) {
                         if (data != null) {
                             $.each(data, function () {

                                 $("#drpAgents").append("<option value = " + this.AgentId + ">" + this.AgentName + "</option>");
                             });
                         }
                         window.page.hideProgress();
                     },
                     error: function (xhr, ajaxOptions, thrownError) {
                         window.page.hideProgress();
                     },
                     dataType: "json"
                 });


             }
         });

    });

    </script>
